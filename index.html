<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>卸検品 QR/JAN スキャン</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; text-align:center; margin:20px; background:#f0f4f8; }
    h1 { color:#2b8a3e; }
    #reader { width: 300px; margin:20px auto; border:2px solid #2b8a3e; border-radius:10px; }
    #log { background:white; border:1px solid #ccc; border-radius:8px; width:90%; max-width:400px; margin:20px auto; padding:10px; text-align:left; font-size:14px; height:180px; overflow-y:auto; }
    button { padding:10px 20px; margin:5px; border:none; border-radius:8px; background-color:#2b8a3e; color:white; font-size:16px; cursor:pointer; }
    button:hover { background-color:#1d6e30; }
  </style>
</head>
<body>
  <h1>卸検品 QR/JAN スキャン</h1>
  <div id="reader"></div>
  <div>
    <button onclick="startScanner()">📱 カメラ起動</button>
    <button onclick="switchCamera()">🔄 カメラ切替</button>
  </div>
  <div id="log"></div>

  <audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

  <script>
    let html5QrCode;
    let devices = [];
    let currentCameraIndex = 0;
    let lastScanTime = 0;

    function append(msg){
      const log = document.getElementById("log");
      log.innerHTML += msg + "<br>";
      log.scrollTop = log.scrollHeight;
    }

    async function startScanner(){
      if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");

      try{
        devices = await Html5Qrcode.getCameras();
        if(devices.length === 0) throw new Error("カメラが見つかりません");
        currentCameraIndex = devices.findIndex(d=>d.facingMode==="environment");
        if(currentCameraIndex<0) currentCameraIndex=0;

        await html5QrCode.start(
          { deviceId: devices[currentCameraIndex].id },
          { fps:10, qrbox:250, formatsToSupport:[Html5QrcodeSupportedFormats.QR_CODE, Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.CODE_39] },
          onScanSuccess
        );
        append(`📱 カメラ起動: ${devices[currentCameraIndex].label}`);
      }catch(err){
        append(`❌ カメラ起動失敗: ${err}`);
      }
    }

    async function switchCamera(){
      if(devices.length<2) return;
      await html5QrCode.stop();
      currentCameraIndex = (currentCameraIndex+1)%devices.length;
      await html5QrCode.start(
        { deviceId: devices[currentCameraIndex].id },
        { fps:10, qrbox:250, formatsToSupport:[Html5QrcodeSupportedFormats.QR_CODE, Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.CODE_39] },
        onScanSuccess
      );
      append(`🔄 カメラ切替: ${devices[currentCameraIndex].label}`);
    }

    function onScanSuccess(decodedText){
      const now = Date.now();
      if(now - lastScanTime < 3000) return; // 3秒間隔
      lastScanTime = now;

      document.getElementById("beep").play();
      append(`読み取り: ${decodedText}`);
      sendToSheet(decodedText);
    }

    async function sendToSheet(text){
      try{
        const res = await fetch("https://script.google.com/macros/s/AKfycbzdDKa7qU-wplVCwtA_7OSbYK5LUCpEU33ngb2TmGNu9qzSgkyzMbv1cjxwR4gTOYMB/exec", { // ← ここに Apps Script の Web アプリ URL
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({text})
        });
        const data = await res.json();
        if(data.status==="success"){
          append(`✅ 書き込み完了: V${data.row}`);
        }else{
          append(`❌ 書き込み失敗: ${data.message}`);
        }
      }catch(err){
        append(`❌ 書き込み失敗: ${err}`);
      }
    }
  </script>
</body>
</html>
