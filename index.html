<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å¸æ¤œå“ã‚¹ã‚­ãƒ£ãƒ³</title>
  <style>
    body { font-family:sans-serif; text-align:center; margin:20px; }
    video { width: 90%; max-width:400px; border:2px solid #2b8a3e; border-radius:10px; }
    button { padding:10px 20px; margin:5px; border:none; border-radius:5px; background:#2b8a3e; color:white; font-size:16px; cursor:pointer; }
    #log { margin-top:15px; max-width:400px; margin-left:auto;margin-right:auto; border:1px solid #ccc; padding:10px; height:150px; overflow:auto; text-align:left;}
  </style>
</head>
<body>

<h1>å¸æ¤œå“QR/JANã‚¹ã‚­ãƒ£ãƒ³</h1>
<video id="video" autoplay></video><br>
<button onclick="startCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
<button onclick="switchCamera()">ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
<div id="log"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
let video = document.getElementById("video");
let log = document.getElementById("log");
let currentDeviceId = null;
let devices = [];

async function startCamera() {
  try {
    devices = await navigator.mediaDevices.enumerateDevices();
    devices = devices.filter(d => d.kind === 'videoinput');
    if (devices.length === 0) throw "ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";

    // èƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆ
    let backCamera = devices.find(d => d.label.toLowerCase().includes('back'));
    currentDeviceId = backCamera ? backCamera.deviceId : devices[0].deviceId;

    const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: currentDeviceId } } });
    video.srcObject = stream;
    video.play();
    logMessage("ğŸ“± ã‚«ãƒ¡ãƒ©èµ·å‹•");

    requestAnimationFrame(scanFrame);
  } catch (e) {
    alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: "+e);
  }
}

function switchCamera() {
  if (devices.length < 2) return;
  let index = devices.findIndex(d=>d.deviceId===currentDeviceId);
  currentDeviceId = devices[(index+1)%devices.length].deviceId;
  startCamera();
}

function logMessage(msg){ log.innerHTML += msg+"<br>"; log.scrollTop = log.scrollHeight; }

function scanFrame() {
  if (!video.videoWidth) { requestAnimationFrame(scanFrame); return; }

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);

  const code = jsQR(imageData.data, canvas.width, canvas.height);
  if(code){
    logMessage("èª­ã¿å–ã‚Š: "+code.data);
    // ã“ã“ã§ Apps Script ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    fetch("YOUR_APPS_SCRIPT_WEBAPP_URL", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({code: code.data})
    })
    .then(r=>r.text())
    .then(res=>logMessage("âœ… "+res))
    .catch(err=>logMessage("âŒ æ›¸ãè¾¼ã¿å¤±æ•—: "+err));
  }

  requestAnimationFrame(scanFrame);
}
</script>

</body>
</html>
