<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>卸検品スキャン</title>
  <style>
    body { font-family:sans-serif; text-align:center; margin:20px; }
    video { width: 90%; max-width:400px; border:2px solid #2b8a3e; border-radius:10px; }
    button { padding:10px 20px; margin:5px; border:none; border-radius:5px; background:#2b8a3e; color:white; font-size:16px; cursor:pointer; }
    #log { margin-top:15px; max-width:400px; margin-left:auto;margin-right:auto; border:1px solid #ccc; padding:10px; height:150px; overflow:auto; text-align:left;}
  </style>
</head>
<body>

<h1>卸検品QR/JANスキャン</h1>
<video id="video" autoplay></video><br>
<button onclick="startCamera()">📷 カメラ起動</button>
<button onclick="switchCamera()">🔄 カメラ切替</button>
<div id="log"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
let video = document.getElementById("video");
let log = document.getElementById("log");
let currentDeviceId = null;
let devices = [];

async function startCamera() {
  try {
    devices = await navigator.mediaDevices.enumerateDevices();
    devices = devices.filter(d => d.kind === 'videoinput');
    if (devices.length === 0) throw "カメラが見つかりません";

    // 背面カメラ優先
    let backCamera = devices.find(d => d.label.toLowerCase().includes('back'));
    currentDeviceId = backCamera ? backCamera.deviceId : devices[0].deviceId;

    const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: currentDeviceId } } });
    video.srcObject = stream;
    video.play();
    logMessage("📱 カメラ起動");

    requestAnimationFrame(scanFrame);
  } catch (e) {
    alert("カメラ起動失敗: "+e);
  }
}

function switchCamera() {
  if (devices.length < 2) return;
  let index = devices.findIndex(d=>d.deviceId===currentDeviceId);
  currentDeviceId = devices[(index+1)%devices.length].deviceId;
  startCamera();
}

function logMessage(msg){ log.innerHTML += msg+"<br>"; log.scrollTop = log.scrollHeight; }

function scanFrame() {
  if (!video.videoWidth) { requestAnimationFrame(scanFrame); return; }

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);

  const code = jsQR(imageData.data, canvas.width, canvas.height);
  if(code){
    logMessage("読み取り: "+code.data);
    // ここで Apps Script サーバーに送信
    fetch("YOUR_APPS_SCRIPT_WEBAPP_URL", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({code: code.data})
    })
    .then(r=>r.text())
    .then(res=>logMessage("✅ "+res))
    .catch(err=>logMessage("❌ 書き込み失敗: "+err));
  }

  requestAnimationFrame(scanFrame);
}
</script>

</body>
</html>
