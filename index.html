<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å¸æ¤œå“ QR/JAN ã‚¹ã‚­ãƒ£ãƒ³</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: "Segoe UI", sans-serif; text-align:center; margin:20px; background:#f0f4f8; }
    h1 { color:#2b8a3e; }
    #reader { width: 300px; margin:20px auto; border:2px solid #2b8a3e; border-radius:10px; }
    #log { background:white; border:1px solid #ccc; border-radius:8px; width:90%; max-width:400px; margin:20px auto; padding:10px; text-align:left; font-size:14px; height:180px; overflow-y:auto; }
    button { padding:10px 20px; margin:5px; border:none; border-radius:8px; background-color:#2b8a3e; color:white; font-size:16px; cursor:pointer; }
    button:hover { background-color:#1d6e30; }
  </style>
</head>
<body>
  <h1>å¸æ¤œå“ QR/JAN ã‚¹ã‚­ãƒ£ãƒ³</h1>
  <div id="reader"></div>
  <div>
    <button onclick="startScanner()">ğŸ“± ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
    <button onclick="switchCamera()">ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
  </div>
  <div id="log"></div>

  <audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

  <script>
    let html5QrCode;
    let devices = [];
    let currentCameraIndex = 0;
    let lastScanTime = 0;

    function append(msg){
      const log = document.getElementById("log");
      log.innerHTML += msg + "<br>";
      log.scrollTop = log.scrollHeight;
    }

    async function startScanner(){
      if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");

      try{
        devices = await Html5Qrcode.getCameras();
        if(devices.length === 0) throw new Error("ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        currentCameraIndex = devices.findIndex(d=>d.facingMode==="environment");
        if(currentCameraIndex<0) currentCameraIndex=0;

        await html5QrCode.start(
          { deviceId: devices[currentCameraIndex].id },
          { fps:10, qrbox:250, formatsToSupport:[Html5QrcodeSupportedFormats.QR_CODE, Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.CODE_39] },
          onScanSuccess
        );
        append(`ğŸ“± ã‚«ãƒ¡ãƒ©èµ·å‹•: ${devices[currentCameraIndex].label}`);
      }catch(err){
        append(`âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: ${err}`);
      }
    }

    async function switchCamera(){
      if(devices.length<2) return;
      await html5QrCode.stop();
      currentCameraIndex = (currentCameraIndex+1)%devices.length;
      await html5QrCode.start(
        { deviceId: devices[currentCameraIndex].id },
        { fps:10, qrbox:250, formatsToSupport:[Html5QrcodeSupportedFormats.QR_CODE, Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.CODE_39] },
        onScanSuccess
      );
      append(`ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿: ${devices[currentCameraIndex].label}`);
    }

    function onScanSuccess(decodedText){
      const now = Date.now();
      if(now - lastScanTime < 3000) return; // 3ç§’é–“éš”
      lastScanTime = now;

      document.getElementById("beep").play();
      append(`èª­ã¿å–ã‚Š: ${decodedText}`);
      sendToSheet(decodedText);
    }

    async function sendToSheet(text){
      try{
        const res = await fetch("https://script.google.com/macros/s/AKfycbzdDKa7qU-wplVCwtA_7OSbYK5LUCpEU33ngb2TmGNu9qzSgkyzMbv1cjxwR4gTOYMB/exec", { // â† ã“ã“ã« Apps Script ã® Web ã‚¢ãƒ—ãƒª URL
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({text})
        });
        const data = await res.json();
        if(data.status==="success"){
          append(`âœ… æ›¸ãè¾¼ã¿å®Œäº†: V${data.row}`);
        }else{
          append(`âŒ æ›¸ãè¾¼ã¿å¤±æ•—: ${data.message}`);
        }
      }catch(err){
        append(`âŒ æ›¸ãè¾¼ã¿å¤±æ•—: ${err}`);
      }
    }
  </script>
</body>
</html>
