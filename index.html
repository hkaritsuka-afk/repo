<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>卸検品QR/バーコードスキャン</title>
<style>
body { font-family:"Segoe UI",sans-serif; text-align:center; margin:20px; background:#f0f4f8;}
h1 { color:#2b8a3e;}
#reader { width:300px; height:300px; margin:20px auto; border:2px solid #2b8a3e; border-radius:10px;}
#log { background:white; border:1px solid #ccc; border-radius:8px; width:90%; max-width:400px; margin:20px auto; padding:10px; text-align:left; font-size:14px; height:180px; overflow-y:auto;}
button { padding:10px 20px; margin:5px; border:none; border-radius:8px; background-color:#2b8a3e; color:white; font-size:16px; cursor:pointer;}
button:hover { background-color:#1d6e30;}
</style>
</head>
<body>
<h1>卸検品QR/バーコードスキャン</h1>
<video id="reader" autoplay playsinline></video>
<div>
  <button onclick="startScanner()">📱 カメラ起動</button>
  <button onclick="switchCamera()">🔄 カメラ切替</button>
</div>
<div id="log"></div>

<audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
<script>
let selectedDeviceId = null;
let devices = [];
let codeReader = null;
let lastScan = 0;

const video = document.getElementById("reader");
const log = document.getElementById("log");
const beep = document.getElementById("beep");

// ここに WebアプリのデプロイURLを置き換えて
const WEB_APP_URL = "YOUR_WEB_APP_URL_HERE";

function append(msg){
  log.innerHTML += msg + "<br>";
  log.scrollTop = log.scrollHeight;
}

// カメラ起動
async function startScanner(){
  codeReader = new ZXing.BrowserMultiFormatContinuousReader();
  try{
    devices = await ZXing.BrowserMultiFormatReader.listVideoInputDevices();
    if(devices.length === 0) throw "カメラが見つかりません";
    selectedDeviceId = devices.find(d => d.label.toLowerCase().includes("back"))?.deviceId || devices[0].deviceId;
    codeReader.decodeFromVideoDevice(selectedDeviceId, video, (result, err) => {
      if(result && Date.now() - lastScan > 3000){
        lastScan = Date.now();
        const text = result.getText();
        append("読み取り: "+text);
        beep.play();
        sendToSheet(text);
      }
    });
    append("📱 カメラ起動しました: "+devices.find(d=>d.deviceId===selectedDeviceId).label);
  }catch(e){
    append("❌ カメラ取得失敗: "+e);
  }
}

// カメラ切替
async function switchCamera(){
  if(devices.length < 2) return;
  let index = devices.findIndex(d=>d.deviceId===selectedDeviceId);
  index = (index+1)%devices.length;
  selectedDeviceId = devices[index].deviceId;
  codeReader.reset();
  startScanner();
}

// スプレッドシートに送信
async function sendToSheet(text){
  try{
    const res = await fetch(https://script.google.com/macros/s/AKfycbzlxHbev18P_mgt_aJ5UU14g1iGKqDdcTPqQ0g9LMRL0JMDu1hp20VMryWideNXZrU-/exec,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({text:text})
    });
    const json = await res.json();
    if(json.status==="ok") append("✅ "+json.message);
    else append("❌ "+json.message);
  }catch(err){
    append("❌ 書き込み失敗: "+err);
  }
}
</script>
</body>
</html>
