<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>å¸æ¤œå“ã‚¹ã‚­ãƒ£ãƒ³</title>
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
<style>
body { font-family:"Segoe UI",sans-serif; text-align:center; background:#f0f4f8; margin:0; padding:0; }
h1 { color:#2b8a3e; margin:20px 0; }
#video-container { position: relative; display:inline-block; margin-top:10px; }
video { width:300px; height:300px; border:2px solid #2b8a3e; border-radius:10px; }
#controls { margin-top:10px; }
button { margin:5px; padding:10px 15px; font-size:16px; border:none; border-radius:8px; background:#2b8a3e; color:white; cursor:pointer; }
button:hover { background:#1d6e30; }
#log { width:90%; max-width:400px; margin:10px auto; padding:10px; background:white; border:1px solid #ccc; border-radius:8px; text-align:left; font-size:14px; height:180px; overflow-y:auto; }
</style>
</head>
<body>
<h1>å¸æ¤œå“ QR / JAN ã‚¹ã‚­ãƒ£ãƒ³</h1>

<div id="video-container">
  <video id="video" autoplay muted></video>
</div>

<div id="controls">
  <button onclick="startCamera()">ğŸ“± ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
  <button onclick="switchCamera()">ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿</button>
</div>

<div id="log"></div>

<script>
let selectedDeviceId = null;
let devices = [];
let currentIndex = 0;
let codeReader = null;
let lastScanTime = 0;
const log = document.getElementById("log");
const video = document.getElementById("video");
const beep = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");

function appendLog(msg){
  log.innerHTML += msg+"<br>";
  log.scrollTop = log.scrollHeight;
}

async function startCamera(){
  codeReader = new ZXing.BrowserMultiFormatReader();
  try{
    devices = await codeReader.listVideoInputDevices();
    if(devices.length==0) { appendLog("âŒ ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
    currentIndex = devices.findIndex(d=>d.label.toLowerCase().includes("back"));
    if(currentIndex<0) currentIndex=0;
    selectedDeviceId = devices[currentIndex].deviceId;
    scanLoop();
    appendLog("ğŸ“± ã‚«ãƒ¡ãƒ©èµ·å‹•: "+devices[currentIndex].label);
  } catch(e){
    appendLog("âŒ ã‚«ãƒ¡ãƒ©å–å¾—å¤±æ•—: "+e);
  }
}

function switchCamera(){
  if(devices.length<2) return;
  currentIndex = (currentIndex+1)%devices.length;
  selectedDeviceId = devices[currentIndex].deviceId;
  appendLog("ğŸ”„ ã‚«ãƒ¡ãƒ©åˆ‡æ›¿: "+devices[currentIndex].label);
  scanLoop();
}

function scanLoop(){
  if(codeReader) codeReader.reset();
  codeReader.decodeFromVideoDevice(selectedDeviceId, video, (result, err)=>{
    if(result){
      const now = Date.now();
      if(now - lastScanTime < 3000) return;
      lastScanTime = now;
      const text = result.getText();
      appendLog("èª­ã¿å–ã‚Š: "+text);
      beep.play();
      sendToServer(text);
    }
    if(err && !(err instanceof ZXing.NotFoundException)) {
      console.error(err);
    }
  });
}

function sendToServer(text){
  fetch("https://script.google.com/macros/s/AKfycbw5BLwkWMOmMiYulfZgrk-3v6tlJhDya2A9arjUb_aqZj-FO3eXygJbX8zCBVZS0Ywn/exec",{
    method:"POST",
    body: JSON.stringify({text:text}),
    headers: {"Content-Type":"application/json"}
  })
  .then(r=>r.json())
  .then(j=>{
    if(j.status==="ok") appendLog("âœ… æ›¸ãè¾¼ã¿å®Œäº†: "+j.message);
    else appendLog("âŒ æ›¸ãè¾¼ã¿å¤±æ•—: "+j.message);
  })
  .catch(e=>appendLog("âŒ æ›¸ãè¾¼ã¿å¤±æ•—: "+e));
}
</script>
</body>
</html>
